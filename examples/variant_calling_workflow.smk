# Example Variant Calling Snakefile
# This demonstrates what Snakemaker would help you create

# This file shows example Snakemake rules for variant calling
# These rules would be generated by the Snakemaker add-in from your command history

# Configuration
SAMPLES = ["sample1", "sample2", "sample3"]
REFERENCE = "reference/genome.fa"

# Rule to call all variants
rule all:
    input:
        expand("variants/{sample}.vcf", sample=SAMPLES),
        expand("variants/{sample}.filtered.vcf", sample=SAMPLES)

# Rule 1: Align reads with BWA
# Generated from command: bwa mem -t 8 reference.fa sample_R1.fastq sample_R2.fastq > aligned.sam
rule align_reads:
    input:
        ref=REFERENCE,
        r1="fastq/{sample}_R1.fastq",
        r2="fastq/{sample}_R2.fastq"
    output:
        "aligned/{sample}.sam"
    log:
        "logs/align/{sample}.log"
    threads: 8
    shell:
        "bwa mem -t {threads} {input.ref} {input.r1} {input.r2} > {output} 2> {log}"

# Rule 2: Convert SAM to BAM
# Generated from command: samtools view -b aligned.sam > aligned.bam
rule sam_to_bam:
    input:
        "aligned/{sample}.sam"
    output:
        "aligned/{sample}.bam"
    log:
        "logs/sam_to_bam/{sample}.log"
    shell:
        "samtools view -b {input} > {output} 2> {log}"

# Rule 3: Sort BAM file
# Generated from command: samtools sort aligned.bam -o aligned.sorted.bam
rule sort_bam:
    input:
        "aligned/{sample}.bam"
    output:
        "aligned/{sample}.sorted.bam"
    log:
        "logs/sort_bam/{sample}.log"
    shell:
        "samtools sort {input} -o {output} 2> {log}"

# Rule 4: Mark duplicates
# Generated from command: picard MarkDuplicates I=aligned.sorted.bam O=marked.bam M=metrics.txt
rule mark_duplicates:
    input:
        "aligned/{sample}.sorted.bam"
    output:
        bam="aligned/{sample}.marked.bam",
        metrics="qc/{sample}.dup_metrics.txt"
    log:
        "logs/mark_duplicates/{sample}.log"
    shell:
        "picard MarkDuplicates I={input} O={output.bam} M={output.metrics} 2> {log}"

# Rule 5: Index BAM file
# Generated from command: samtools index marked.bam
rule index_bam:
    input:
        "aligned/{sample}.marked.bam"
    output:
        "aligned/{sample}.marked.bam.bai"
    log:
        "logs/index_bam/{sample}.log"
    shell:
        "samtools index {input} 2> {log}"

# Rule 6: Call variants with GATK HaplotypeCaller
# Generated from command: gatk HaplotypeCaller -R reference.fa -I marked.bam -O variants.vcf
rule call_variants_gatk:
    input:
        ref=REFERENCE,
        bam="aligned/{sample}.marked.bam",
        bai="aligned/{sample}.marked.bam.bai"
    output:
        "variants/{sample}.vcf"
    log:
        "logs/call_variants/{sample}.log"
    shell:
        "gatk HaplotypeCaller -R {input.ref} -I {input.bam} -O {output} 2> {log}"

# Alternative Rule: Call variants with bcftools
# Generated from command: bcftools mpileup -f reference.fa marked.bam | bcftools call -mv -o variants.vcf
rule call_variants_bcftools:
    input:
        ref=REFERENCE,
        bam="aligned/{sample}.marked.bam",
        bai="aligned/{sample}.marked.bam.bai"
    output:
        "variants/{sample}.bcftools.vcf"
    log:
        "logs/call_variants_bcftools/{sample}.log"
    shell:
        "bcftools mpileup -f {input.ref} {input.bam} | bcftools call -mv -o {output} 2> {log}"

# Alternative Rule: Call variants with FreeBayes
# Generated from command: freebayes -f reference.fa marked.bam > variants.vcf
rule call_variants_freebayes:
    input:
        ref=REFERENCE,
        bam="aligned/{sample}.marked.bam",
        bai="aligned/{sample}.marked.bam.bai"
    output:
        "variants/{sample}.freebayes.vcf"
    log:
        "logs/call_variants_freebayes/{sample}.log"
    shell:
        "freebayes -f {input.ref} {input.bam} > {output} 2> {log}"

# Rule 7: Filter variants
# Generated from command: gatk VariantFiltration -R reference.fa -V variants.vcf -O filtered.vcf
rule filter_variants:
    input:
        ref=REFERENCE,
        vcf="variants/{sample}.vcf"
    output:
        "variants/{sample}.filtered.vcf"
    log:
        "logs/filter_variants/{sample}.log"
    params:
        filters='--filter-expression "QD < 2.0" --filter-name "QD2" --filter-expression "FS > 60.0" --filter-name "FS60"'
    shell:
        "gatk VariantFiltration -R {input.ref} -V {input.vcf} -O {output} {params.filters} 2> {log}"

# Rule 8: Annotate variants
# Generated from command: bcftools annotate -a annotations.bed.gz filtered.vcf > annotated.vcf
rule annotate_variants:
    input:
        vcf="variants/{sample}.filtered.vcf",
        annotations="annotations/dbsnp.vcf.gz"
    output:
        "variants/{sample}.annotated.vcf"
    log:
        "logs/annotate_variants/{sample}.log"
    shell:
        "bcftools annotate -a {input.annotations} {input.vcf} > {output} 2> {log}"

# Rule 9: Generate variant statistics
# Generated from command: bcftools stats variants.vcf > stats.txt
rule variant_stats:
    input:
        "variants/{sample}.filtered.vcf"
    output:
        "qc/{sample}.variant_stats.txt"
    log:
        "logs/variant_stats/{sample}.log"
    shell:
        "bcftools stats {input} > {output} 2> {log}"

# Rule 10: Generate MultiQC report
# Generated from command: multiqc logs/ -o reports/
rule multiqc:
    input:
        expand("qc/{sample}.variant_stats.txt", sample=SAMPLES),
        expand("qc/{sample}.dup_metrics.txt", sample=SAMPLES)
    output:
        "reports/multiqc_report.html"
    log:
        "logs/multiqc.log"
    shell:
        "multiqc logs/ qc/ -o reports/ 2> {log}"
